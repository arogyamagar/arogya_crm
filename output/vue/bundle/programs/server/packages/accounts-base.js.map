{"version":3,"sources":["meteor://ðŸ’»app/packages/accounts-base/server_main.js","meteor://ðŸ’»app/packages/accounts-base/accounts_common.js","meteor://ðŸ’»app/packages/accounts-base/accounts_server.js"],"names":["module1","export","AccountsServer","link","v","Accounts","Meteor","server","users","_objectSpread","module","default","AccountsCommon","EXPIRE_TOKENS_INTERVAL_MS","VALID_CONFIG_KEYS","constructor","options","_options","connection","undefined","_initConnection","_initializeCollection","_onLoginHook","Hook","bindEnvironment","debugPrintExceptions","_onLoginFailureHook","_onLogoutHook","DEFAULT_LOGIN_EXPIRATION_DAYS","LOGIN_UNEXPIRING_TOKEN_DAYS","lceName","LoginCancelledError","makeErrorType","description","message","prototype","name","numericError","collection","Mongo","Collection","Error","collectionName","_preventAutopublish","userId","_addDefaultFieldSelector","defaultFieldSelector","fields","keys","Object","length","keys2","user","findOne","userAsync","findOneAsync","config","isServer","__meteor_runtime_config__","accountsConfigCalled","_debug","hasOwnProperty","call","isClient","Package","OAuthEncryption","loadKey","oauthSecretKey","forEach","key","includes","_name","onLogin","func","ret","register","_startupCallback","callback","onLoginFailure","onLogout","ddpUrl","DDP","connect","ACCOUNTS_CONNECTION_URL","_getTokenLifetimeMs","loginExpirationInDays","loginExpiration","_getPasswordResetTokenLifetimeMs","passwordResetTokenExpiration","passwordResetTokenExpirationInDays","DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS","_getPasswordEnrollTokenLifetimeMs","passwordEnrollTokenExpiration","passwordEnrollTokenExpirationInDays","DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS","_tokenExpiration","when","Date","getTime","_tokenExpiresSoon","minLifetimeMs","minLifetimeCapMs","MIN_TOKEN_LIFETIME_CAP_SECS","_objectWithoutProperties","crypto","URL","hasOwn","NonEmptyString","Match","Where","x","check","String","onCreateLoginToken","_onCreateLoginTokenHook","_selectorForFastCaseInsensitiveLookup","fieldName","string","prefix","substring","Math","min","orClause","generateCasePermutationsForString","map","prefixPermutation","selector","RegExp","_escapeRegExp","caseInsensitiveClause","$and","$or","_findUserByQuery","query","id","fieldValue","username","email","candidateUsers","find","limit","fetch","_handleError","msg","throwError","errorCode","error","ambiguousErrorMessages","_userQueryValidator","Optional","_server","_initServerMethods","_initAccountDataHooks","_autopublishFields","loggedInUser","otherUsers","_defaultPublishFields","projection","profile","emails","_initServerPublications","_accountData","_userObservesForConnections","_nextUserObserveNumber","_loginHandlers","setupUsersCollection","setupDefaultLoginHandlers","setExpireTokensInterval","_validateLoginHook","_validateNewUserHooks","defaultValidateNewUserHook","bind","_deleteSavedTokensForAllUsersOnStartup","_skipCaseInsensitiveChecksForTest","urls","resetPassword","token","extraParams","buildEmailUrl","verifyEmail","loginToken","enrollAccount","addDefaultRateLimit","path","url","absoluteUrl","params","entries","value","searchParams","append","toString","currentInvocation","_CurrentMethodInvocation","get","_CurrentPublicationInvocation","validateLoginAttempt","validateNewUser","push","beforeExternalLogin","_beforeExternalLoginHook","onCreateUser","_onCreateUserHook","wrapFn","onExternalLogin","_onExternalLoginHook","setAdditionalFindUserOnExternalLogin","_additionalFindUserOnExternalLogin","_validateLogin","attempt","cloneAttemptWithConnection","e","allowed","_successfulLogin","each","_failedLogin","_successfulLogout","_loginUser","methodInvocation","stampedLoginToken","_generateStampedLoginToken","_insertLoginToken","_noYieldsAllowed","_setLoginToken","_hashLoginToken","setUserId","tokenExpires","_attemptLogin","methodName","methodArgs","result","type","methodArguments","Array","from","_loginMethod","fn","tryLoginMethod","_reportLoginFailure","registerLoginHandler","handler","_runLoginHandlers","destroyToken","update","$pull","hashedToken","accounts","methods","login","arguments","logout","_getLoginToken","getNewToken","currentHashedToken","currentStampedToken","services","resume","loginTokens","stampedToken","newStampedToken","removeOtherTokens","currentToken","$ne","configureLoginService","ObjectIncluding","service","oauth","serviceNames","ServiceConfiguration","configurations","keyIsLoaded","secret","seal","insert","onConnection","onClose","_removeTokenFromConnection","publish","ready","is_auto","startup","customFields","_id","autopublish","toFieldSelector","reduce","prev","field","addAutopublishFields","opts","apply","forLoggedInUser","forOtherUsers","setDefaultPublishFields","_getAccountData","connectionId","data","_setAccountData","hash","createHash","digest","_hashStampedToken","hashedStampedToken","_insertHashedLoginToken","$addToSet","_clearAllLoginTokens","$set","_getUserObserve","observe","stop","newToken","myObserveNumber","defer","foundMatchingUser","observeChanges","added","removed","close","nonMutatingCallbacks","Random","_expirePasswordResetTokens","oldestValidDate","tokenLifetimeMs","tokenFilter","$exists","expirePasswordToken","_expirePasswordEnrollTokens","_expireTokens","userFilter","$lt","multi","superResult","expireTokenInterval","clearInterval","insertUserDoc","createdAt","pinEncryptedFieldsToUser","fullUser","defaultCreateUserHook","hook","errmsg","_testEmailDomain","domain","restrictCreationByEmailDomain","test","_deleteSavedTokensForUser","tokensToDelete","$unset","$pullAll","loginTokensToDelete","updateOrCreateUserFromExternalService","serviceName","serviceData","serviceIdKey","isNaN","parseInt","setAttrs","removeDefaultRateLimit","resp","DDPRateLimiter","removeRule","defaultRateLimiterRuleId","addRule","clientAddress","generateOptionsForEmail","reason","extra","to","emailTemplates","subject","text","html","headers","_checkForCaseInsensitiveDuplicates","displayName","ownUserId","skipCheck","matchedUsers","_createUserCheckingDuplicates","newUser","address","verified","ex","remove","clonedAttempt","EJSON","clone","defaultResumeLoginHandler","oldUnhashedStyleToken","isEnroll","resetRangeOr","expireFilter","setInterval","isSealed","open","emailIsGood","values","allow","modifier","createIndex","unique","sparse","permutations","i","ch","charAt","concat","lowerCaseChar","toLowerCase","upperCaseChar","toUpperCase"],"mappings":"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AAM,EAAE,IAAI,CAACC,wBAAwB,CAAC7B,OAAO,CAAC,CAAC,GAClE,IAAI;EACV;;EAEA;AACF;AACA;AACA;AACA;AACA;EACQsC,SAAS,CAACtC,OAAO;IAAA,gCAAE;MACvB,MAAM4B,MAAM,GAAG,IAAI,CAACA,MAAM,EAAE;MAC5B,OAAOA,MAAM,GACT,IAAI,CAACpC,KAAK,CAAC+C,YAAY,CAACX,MAAM,EAAE,IAAI,CAACC,wBAAwB,CAAC7B,OAAO,CAAC,CAAC,GACvE,IAAI;IACV,CAAC;EAAA;EACD;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEwC,MAAM,CAACxC,OAAO,EAAE;IACd;IACA;IACA;IACA;IACA;IACA,IAAIV,MAAM,CAACmD,QAAQ,EAAE;MACnBC,yBAAyB,CAACC,oBAAoB,GAAG,IAAI;IACvD,CAAC,MAAM,IAAI,CAACD,yBAAyB,CAACC,oBAAoB,EAAE;MAC1D;MACA;MACArD,MAAM,CAACsD,MAAM,CACX,0DAA0D,GACxD,yDAAyD,CAC5D;IACH;;IAEA;IACA;IACA;IACA,IAAIX,MAAM,CAACd,SAAS,CAAC0B,cAAc,CAACC,IAAI,CAAC9C,OAAO,EAAE,gBAAgB,CAAC,EAAE;MACnE,IAAIV,MAAM,CAACyD,QAAQ,EAAE;QACnB,MAAM,IAAItB,KAAK,CACb,+DAA+D,CAChE;MACH;MACA,IAAI,CAACuB,OAAO,CAAC,kBAAkB,CAAC,EAAE;QAChC,MAAM,IAAIvB,KAAK,CACb,mEAAmE,CACpE;MACH;MACAuB,OAAO,CAAC,kBAAkB,CAAC,CAACC,eAAe,CAACC,OAAO,CACjDlD,OAAO,CAACmD,cAAc,CACvB;MACDnD,OAAO,qBAAQ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","file":"/packages/accounts-base.js","sourcesContent":["import { AccountsServer } from \"./accounts_server.js\";\n\n/**\n * @namespace Accounts\n * @summary The namespace for all server-side accounts-related methods.\n */\nAccounts = new AccountsServer(Meteor.server);\n\n// Users table. Don't use the normal autopublish, since we want to hide\n// some fields. Code to autopublish this is in accounts_server.js.\n// XXX Allow users to configure this collection name.\n\n/**\n * @summary A [Mongo.Collection](#collections) containing user documents.\n * @locus Anywhere\n * @type {Mongo.Collection}\n * @importFromPackage meteor\n*/\nMeteor.users = Accounts.users;\n\nexport {\n  // Since this file is the main module for the server version of the\n  // accounts-base package, properties of non-entry-point modules need to\n  // be re-exported in order to be accessible to modules that import the\n  // accounts-base package.\n  AccountsServer\n};\n","import { Meteor } from 'meteor/meteor';\n\n// config option keys\nconst VALID_CONFIG_KEYS = [\n  'sendVerificationEmail',\n  'forbidClientAccountCreation',\n  'passwordEnrollTokenExpiration',\n  'passwordEnrollTokenExpirationInDays',\n  'restrictCreationByEmailDomain',\n  'loginExpirationInDays',\n  'loginExpiration',\n  'passwordResetTokenExpirationInDays',\n  'passwordResetTokenExpiration',\n  'ambiguousErrorMessages',\n  'bcryptRounds',\n  'defaultFieldSelector',\n  'loginTokenExpirationHours',\n  'tokenSequenceLength',\n  'collection',\n];\n\n/**\n * @summary Super-constructor for AccountsClient and AccountsServer.\n * @locus Anywhere\n * @class AccountsCommon\n * @instancename accountsClientOrServer\n * @param options {Object} an object with fields:\n * - connection {Object} Optional DDP connection to reuse.\n * - ddpUrl {String} Optional URL for creating a new DDP connection.\n * - collection {String|Mongo.Collection} The name of the Mongo.Collection\n *     or the Mongo.Collection object to hold the users.\n */\nexport class AccountsCommon {\n  constructor(options) {\n    // Currently this is read directly by packages like accounts-password\n    // and accounts-ui-unstyled.\n    this._options = {};\n\n    // Note that setting this.connection = null causes this.users to be a\n    // LocalCollection, which is not what we want.\n    this.connection = undefined;\n    this._initConnection(options || {});\n\n    // There is an allow call in accounts_server.js that restricts writes to\n    // this collection.\n    this.users = this._initializeCollection(options || {});\n\n    // Callback exceptions are printed with Meteor._debug and ignored.\n    this._onLoginHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLogin callback',\n    });\n\n    this._onLoginFailureHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLoginFailure callback',\n    });\n\n    this._onLogoutHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLogout callback',\n    });\n\n    // Expose for testing.\n    this.DEFAULT_LOGIN_EXPIRATION_DAYS = DEFAULT_LOGIN_EXPIRATION_DAYS;\n    this.LOGIN_UNEXPIRING_TOKEN_DAYS = LOGIN_UNEXPIRING_TOKEN_DAYS;\n\n    // Thrown when the user cancels the login process (eg, closes an oauth\n    // popup, declines retina scan, etc)\n    const lceName = 'Accounts.LoginCancelledError';\n    this.LoginCancelledError = Meteor.makeErrorType(lceName, function(\n      description\n    ) {\n      this.message = description;\n    });\n    this.LoginCancelledError.prototype.name = lceName;\n\n    // This is used to transmit specific subclass errors over the wire. We\n    // should come up with a more generic way to do this (eg, with some sort of\n    // symbolic error code rather than a number).\n    this.LoginCancelledError.numericError = 0x8acdc2f;\n  }\n\n  _initializeCollection(options) {\n    if (options.collection && typeof options.collection !== 'string' && !(options.collection instanceof Mongo.Collection)) {\n      throw new Meteor.Error('Collection parameter can be only of type string or \"Mongo.Collection\"');\n    }\n\n    let collectionName = 'users';\n    if (typeof options.collection === 'string') {\n      collectionName = options.collection;\n    }\n\n    let collection;\n    if (options.collection instanceof Mongo.Collection) {\n      collection = options.collection;\n    } else {\n      collection = new Mongo.Collection(collectionName, {\n        _preventAutopublish: true,\n        connection: this.connection,\n      });\n    }\n\n    return collection;\n  }\n\n  /**\n   * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n   * @locus Anywhere\n   */\n  userId() {\n    throw new Error('userId method not implemented');\n  }\n\n  // merge the defaultFieldSelector with an existing options object\n  _addDefaultFieldSelector(options = {}) {\n    // this will be the most common case for most people, so make it quick\n    if (!this._options.defaultFieldSelector) return options;\n\n    // if no field selector then just use defaultFieldSelector\n    if (!options.fields)\n      return {\n        ...options,\n        fields: this._options.defaultFieldSelector,\n      };\n\n    // if empty field selector then the full user object is explicitly requested, so obey\n    const keys = Object.keys(options.fields);\n    if (!keys.length) return options;\n\n    // if the requested fields are +ve then ignore defaultFieldSelector\n    // assume they are all either +ve or -ve because Mongo doesn't like mixed\n    if (!!options.fields[keys[0]]) return options;\n\n    // The requested fields are -ve.\n    // If the defaultFieldSelector is +ve then use requested fields, otherwise merge them\n    const keys2 = Object.keys(this._options.defaultFieldSelector);\n    return this._options.defaultFieldSelector[keys2[0]]\n      ? options\n      : {\n          ...options,\n          fields: {\n            ...options.fields,\n            ...this._options.defaultFieldSelector,\n          },\n        };\n  }\n\n  /**\n   * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n   * @locus Anywhere\n   * @param {Object} [options]\n   * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n   */\n  user(options) {\n    const userId = this.userId();\n    return userId\n      ? this.users.findOne(userId, this._addDefaultFieldSelector(options))\n      : null;\n  }\n\n  /**\n   * @summary Get the current user record, or `null` if no user is logged in.\n   * @locus Anywhere\n   * @param {Object} [options]\n   * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n   */\n  async userAsync(options) {\n    const userId = this.userId();\n    return userId\n      ? this.users.findOneAsync(userId, this._addDefaultFieldSelector(options))\n      : null;\n  }\n  // Set up config for the accounts system. Call this on both the client\n  // and the server.\n  //\n  // Note that this method gets overridden on AccountsServer.prototype, but\n  // the overriding method calls the overridden method.\n  //\n  // XXX we should add some enforcement that this is called on both the\n  // client and the server. Otherwise, a user can\n  // 'forbidClientAccountCreation' only on the client and while it looks\n  // like their app is secure, the server will still accept createUser\n  // calls. https://github.com/meteor/meteor/issues/828\n  //\n  // @param options {Object} an object with fields:\n  // - sendVerificationEmail {Boolean}\n  //     Send email address verification emails to new users created from\n  //     client signups.\n  // - forbidClientAccountCreation {Boolean}\n  //     Do not allow clients to create accounts directly.\n  // - restrictCreationByEmailDomain {Function or String}\n  //     Require created users to have an email matching the function or\n  //     having the string as domain.\n  // - loginExpirationInDays {Number}\n  //     Number of days since login until a user is logged out (login token\n  //     expires).\n  // - collection {String|Mongo.Collection}\n  //     A collection name or a Mongo.Collection object to hold the users.\n  // - passwordResetTokenExpirationInDays {Number}\n  //     Number of days since password reset token creation until the\n  //     token cannt be used any longer (password reset token expires).\n  // - ambiguousErrorMessages {Boolean}\n  //     Return ambiguous error messages from login failures to prevent\n  //     user enumeration.\n  // - bcryptRounds {Number}\n  //     Allows override of number of bcrypt rounds (aka work factor) used\n  //     to store passwords.\n\n  /**\n   * @summary Set global accounts options. You can also set these in `Meteor.settings.packages.accounts` without the need to call this function.\n   * @locus Anywhere\n   * @param {Object} options\n   * @param {Boolean} options.sendVerificationEmail New users with an email address will receive an address verification email.\n   * @param {Boolean} options.forbidClientAccountCreation Calls to [`createUser`](#accounts_createuser) from the client will be rejected. In addition, if you are using [accounts-ui](#accountsui), the \"Create account\" link will not be available.\n   * @param {String | Function} options.restrictCreationByEmailDomain If set to a string, only allows new users if the domain part of their email address matches the string. If set to a function, only allows new users if the function returns true.  The function is passed the full email address of the proposed new user.  Works with password-based sign-in and external services that expose email addresses (Google, Facebook, GitHub). All existing users still can log in after enabling this option. Example: `Accounts.config({ restrictCreationByEmailDomain: 'school.edu' })`.\n   * @param {Number} options.loginExpirationInDays The number of days from when a user logs in until their token expires and they are logged out. Defaults to 90. Set to `null` to disable login expiration.\n   * @param {Number} options.loginExpiration The number of milliseconds from when a user logs in until their token expires and they are logged out, for a more granular control. If `loginExpirationInDays` is set, it takes precedent.\n   * @param {String} options.oauthSecretKey When using the `oauth-encryption` package, the 16 byte key using to encrypt sensitive account credentials in the database, encoded in base64.  This option may only be specified on the server.  See packages/oauth-encryption/README.md for details.\n   * @param {Number} options.passwordResetTokenExpirationInDays The number of days from when a link to reset password is sent until token expires and user can't reset password with the link anymore. Defaults to 3.\n   * @param {Number} options.passwordResetTokenExpiration The number of milliseconds from when a link to reset password is sent until token expires and user can't reset password with the link anymore. If `passwordResetTokenExpirationInDays` is set, it takes precedent.\n   * @param {Number} options.passwordEnrollTokenExpirationInDays The number of days from when a link to set initial password is sent until token expires and user can't set password with the link anymore. Defaults to 30.\n   * @param {Number} options.passwordEnrollTokenExpiration The number of milliseconds from when a link to set initial password is sent until token expires and user can't set password with the link anymore. If `passwordEnrollTokenExpirationInDays` is set, it takes precedent.\n   * @param {Boolean} options.ambiguousErrorMessages Return ambiguous error messages from login failures to prevent user enumeration. Defaults to false.\n   * @param {MongoFieldSpecifier} options.defaultFieldSelector To exclude by default large custom fields from `Meteor.user()` and `Meteor.findUserBy...()` functions when called without a field selector, and all `onLogin`, `onLoginFailure` and `onLogout` callbacks.  Example: `Accounts.config({ defaultFieldSelector: { myBigArray: 0 }})`. Beware when using this. If, for instance, you do not include `email` when excluding the fields, you can have problems with functions like `forgotPassword` that will break because they won't have the required data available. It's recommend that you always keep the fields `_id`, `username`, and `email`.\n   * @param {String|Mongo.Collection} options.collection A collection name or a Mongo.Collection object to hold the users.\n   * @param {Number} options.loginTokenExpirationHours When using the package `accounts-2fa`, use this to set the amount of time a token sent is valid. As it's just a number, you can use, for example, 0.5 to make the token valid for just half hour. The default is 1 hour.\n   * @param {Number} options.tokenSequenceLength When using the package `accounts-2fa`, use this to the size of the token sequence generated. The default is 6.\n   */\n  config(options) {\n    // We don't want users to accidentally only call Accounts.config on the\n    // client, where some of the options will have partial effects (eg removing\n    // the \"create account\" button from accounts-ui if forbidClientAccountCreation\n    // is set, or redirecting Google login to a specific-domain page) without\n    // having their full effects.\n    if (Meteor.isServer) {\n      __meteor_runtime_config__.accountsConfigCalled = true;\n    } else if (!__meteor_runtime_config__.accountsConfigCalled) {\n      // XXX would be nice to \"crash\" the client and replace the UI with an error\n      // message, but there's no trivial way to do this.\n      Meteor._debug(\n        'Accounts.config was called on the client but not on the ' +\n          'server; some configuration options may not take effect.'\n      );\n    }\n\n    // We need to validate the oauthSecretKey option at the time\n    // Accounts.config is called. We also deliberately don't store the\n    // oauthSecretKey in Accounts._options.\n    if (Object.prototype.hasOwnProperty.call(options, 'oauthSecretKey')) {\n      if (Meteor.isClient) {\n        throw new Error(\n          'The oauthSecretKey option may only be specified on the server'\n        );\n      }\n      if (!Package['oauth-encryption']) {\n        throw new Error(\n          'The oauth-encryption package must be loaded to set oauthSecretKey'\n        );\n      }\n      Package['oauth-encryption'].OAuthEncryption.loadKey(\n        options.oauthSecretKey\n      );\n      options = { ...options };\n      delete options.oauthSecretKey;\n    }\n\n    // Validate config options keys\n    Object.keys(options).forEach(key => {\n      if (!VALID_CONFIG_KEYS.includes(key)) {\n        // TODO Consider just logging a debug message instead to allow for additional keys in the settings here?\n        throw new Meteor.Error(`Accounts.config: Invalid key: ${key}`);\n      }\n    });\n\n    // set values in Accounts._options\n    VALID_CONFIG_KEYS.forEach(key => {\n      if (key in options) {\n        if (key in this._options) {\n          if (key !== 'collection') {\n            throw new Meteor.Error(`Can't set \\`${key}\\` more than once`);\n          }\n        }\n        this._options[key] = options[key];\n      }\n    });\n\n    if (options.collection && options.collection !== this.users._name && options.collection !== this.users) {\n      this.users = this._initializeCollection(options);\n    }\n  }\n\n  /**\n   * @summary Register a callback to be called after a login attempt succeeds.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called when login is successful.\n   *                        The callback receives a single object that\n   *                        holds login details. This object contains the login\n   *                        result type (password, resume, etc.) on both the\n   *                        client and server. `onLogin` callbacks registered\n   *                        on the server also receive extra data, such\n   *                        as user details, connection information, etc.\n   */\n  onLogin(func) {\n    let ret = this._onLoginHook.register(func);\n    // call the just registered callback if already logged in\n    this._startupCallback(ret.callback);\n    return ret;\n  }\n\n  /**\n   * @summary Register a callback to be called after a login attempt fails.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called after the login has failed.\n   */\n  onLoginFailure(func) {\n    return this._onLoginFailureHook.register(func);\n  }\n\n  /**\n   * @summary Register a callback to be called after a logout attempt succeeds.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called when logout is successful.\n   */\n  onLogout(func) {\n    return this._onLogoutHook.register(func);\n  }\n\n  _initConnection(options) {\n    if (!Meteor.isClient) {\n      return;\n    }\n\n    // The connection used by the Accounts system. This is the connection\n    // that will get logged in by Meteor.login(), and this is the\n    // connection whose login state will be reflected by Meteor.userId().\n    //\n    // It would be much preferable for this to be in accounts_client.js,\n    // but it has to be here because it's needed to create the\n    // Meteor.users collection.\n    if (options.connection) {\n      this.connection = options.connection;\n    } else if (options.ddpUrl) {\n      this.connection = DDP.connect(options.ddpUrl);\n    } else if (\n      typeof __meteor_runtime_config__ !== 'undefined' &&\n      __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL\n    ) {\n      // Temporary, internal hook to allow the server to point the client\n      // to a different authentication server. This is for a very\n      // particular use case that comes up when implementing a oauth\n      // server. Unsupported and may go away at any point in time.\n      //\n      // We will eventually provide a general way to use account-base\n      // against any DDP connection, not just one special one.\n      this.connection = DDP.connect(\n        __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL\n      );\n    } else {\n      this.connection = Meteor.connection;\n    }\n  }\n\n  _getTokenLifetimeMs() {\n    // When loginExpirationInDays is set to null, we'll use a really high\n    // number of days (LOGIN_UNEXPIRABLE_TOKEN_DAYS) to simulate an\n    // unexpiring token.\n    const loginExpirationInDays =\n      this._options.loginExpirationInDays === null\n        ? LOGIN_UNEXPIRING_TOKEN_DAYS\n        : this._options.loginExpirationInDays;\n    return (\n      this._options.loginExpiration ||\n      (loginExpirationInDays || DEFAULT_LOGIN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _getPasswordResetTokenLifetimeMs() {\n    return (\n      this._options.passwordResetTokenExpiration ||\n      (this._options.passwordResetTokenExpirationInDays ||\n        DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _getPasswordEnrollTokenLifetimeMs() {\n    return (\n      this._options.passwordEnrollTokenExpiration ||\n      (this._options.passwordEnrollTokenExpirationInDays ||\n        DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _tokenExpiration(when) {\n    // We pass when through the Date constructor for backwards compatibility;\n    // `when` used to be a number.\n    return new Date(new Date(when).getTime() + this._getTokenLifetimeMs());\n  }\n\n  _tokenExpiresSoon(when) {\n    let minLifetimeMs = 0.1 * this._getTokenLifetimeMs();\n    const minLifetimeCapMs = MIN_TOKEN_LIFETIME_CAP_SECS * 1000;\n    if (minLifetimeMs > minLifetimeCapMs) {\n      minLifetimeMs = minLifetimeCapMs;\n    }\n    return new Date() > new Date(when) - minLifetimeMs;\n  }\n\n  // No-op on the server, overridden on the client.\n  _startupCallback(callback) {}\n}\n\n// Note that Accounts is defined separately in accounts_client.js and\n// accounts_server.js.\n\n/**\n * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere but publish functions\n * @importFromPackage meteor\n */\nMeteor.userId = () => Accounts.userId();\n\n/**\n * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere but publish functions\n * @importFromPackage meteor\n * @param {Object} [options]\n * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n */\nMeteor.user = options => Accounts.user(options);\n\n/**\n * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere but publish functions\n * @importFromPackage meteor\n * @param {Object} [options]\n * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n */\nMeteor.userAsync = options => Accounts.userAsync(options);\n\n// how long (in days) until a login token expires\nconst DEFAULT_LOGIN_EXPIRATION_DAYS = 90;\n// how long (in days) until reset password token expires\nconst DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS = 3;\n// how long (in days) until enrol password token expires\nconst DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS = 30;\n// Clients don't try to auto-login with a token that is going to expire within\n// .1 * DEFAULT_LOGIN_EXPIRATION_DAYS, capped at MIN_TOKEN_LIFETIME_CAP_SECS.\n// Tries to avoid abrupt disconnects from expiring tokens.\nconst MIN_TOKEN_LIFETIME_CAP_SECS = 3600; // one hour\n// how often (in milliseconds) we check for expired tokens\nexport const EXPIRE_TOKENS_INTERVAL_MS = 600 * 1000; // 10 minutes\n// A large number of expiration days (approximately 100 years worth) that is\n// used when creating unexpiring tokens.\nconst LOGIN_UNEXPIRING_TOKEN_DAYS = 365 * 100;\n","import crypto from 'crypto';\nimport { Meteor } from 'meteor/meteor'\nimport {\n  AccountsCommon,\n  EXPIRE_TOKENS_INTERVAL_MS,\n} from './accounts_common.js';\nimport { URL } from 'meteor/url';\n\nconst hasOwn = Object.prototype.hasOwnProperty;\n\n// XXX maybe this belongs in the check package\nconst NonEmptyString = Match.Where(x => {\n  check(x, String);\n  return x.length > 0;\n});\n\n/**\n * @summary Constructor for the `Accounts` namespace on the server.\n * @locus Server\n * @class AccountsServer\n * @extends AccountsCommon\n * @instancename accountsServer\n * @param {Object} server A server object such as `Meteor.server`.\n */\nexport class AccountsServer extends AccountsCommon {\n  // Note that this constructor is less likely to be instantiated multiple\n  // times than the `AccountsClient` constructor, because a single server\n  // can provide only one set of methods.\n  constructor(server, options) {\n    super(options || {});\n\n    this._server = server || Meteor.server;\n    // Set up the server's methods, as if by calling Meteor.methods.\n    this._initServerMethods();\n\n    this._initAccountDataHooks();\n\n    // If autopublish is on, publish these user fields. Login service\n    // packages (eg accounts-google) add to these by calling\n    // addAutopublishFields.  Notably, this isn't implemented with multiple\n    // publishes since DDP only merges only across top-level fields, not\n    // subfields (such as 'services.facebook.accessToken')\n    this._autopublishFields = {\n      loggedInUser: ['profile', 'username', 'emails'],\n      otherUsers: ['profile', 'username']\n    };\n\n    // use object to keep the reference when used in functions\n    // where _defaultPublishFields is destructured into lexical scope\n    // for publish callbacks that need `this`\n    this._defaultPublishFields = {\n      projection: {\n        profile: 1,\n        username: 1,\n        emails: 1,\n      }\n    };\n\n    this._initServerPublications();\n\n    // connectionId -> {connection, loginToken}\n    this._accountData = {};\n\n    // connection id -> observe handle for the login token that this connection is\n    // currently associated with, or a number. The number indicates that we are in\n    // the process of setting up the observe (using a number instead of a single\n    // sentinel allows multiple attempts to set up the observe to identify which\n    // one was theirs).\n    this._userObservesForConnections = {};\n    this._nextUserObserveNumber = 1;  // for the number described above.\n\n    // list of all registered handlers.\n    this._loginHandlers = [];\n\n    setupUsersCollection(this.users);\n    setupDefaultLoginHandlers(this);\n    setExpireTokensInterval(this);\n\n    this._validateLoginHook = new Hook({ bindEnvironment: false });\n    this._validateNewUserHooks = [\n      defaultValidateNewUserHook.bind(this)\n    ];\n\n    this._deleteSavedTokensForAllUsersOnStartup();\n\n    this._skipCaseInsensitiveChecksForTest = {};\n\n    this.urls = {\n      resetPassword: (token, extraParams) => this.buildEmailUrl(`#/reset-password/${token}`, extraParams),\n      verifyEmail: (token, extraParams) => this.buildEmailUrl(`#/verify-email/${token}`, extraParams),\n      loginToken: (selector, token, extraParams) =>\n        this.buildEmailUrl(`/?loginToken=${token}&selector=${selector}`, extraParams),\n      enrollAccount: (token, extraParams) => this.buildEmailUrl(`#/enroll-account/${token}`, extraParams),\n    };\n\n    this.addDefaultRateLimit();\n\n    this.buildEmailUrl = (path, extraParams = {}) => {\n      const url = new URL(Meteor.absoluteUrl(path));\n      const params = Object.entries(extraParams);\n      if (params.length > 0) {\n        // Add additional parameters to the url\n        for (const [key, value] of params) {\n          url.searchParams.append(key, value);\n        }\n      }\n      return url.toString();\n    };\n  }\n\n  ///\n  /// CURRENT USER\n  ///\n\n  // @override of \"abstract\" non-implementation in accounts_common.js\n  userId() {\n    // This function only works if called inside a method or a pubication.\n    // Using any of the information from Meteor.user() in a method or\n    // publish function will always use the value from when the function first\n    // runs. This is likely not what the user expects. The way to make this work\n    // in a method or publish function is to do Meteor.find(this.userId).observe\n    // and recompute when the user record changes.\n    const currentInvocation = DDP._CurrentMethodInvocation.get() || DDP._CurrentPublicationInvocation.get();\n    if (!currentInvocation)\n      throw new Error(\"Meteor.userId can only be invoked in method calls or publications.\");\n    return currentInvocation.userId;\n  }\n\n  ///\n  /// LOGIN HOOKS\n  ///\n\n  /**\n   * @summary Validate login attempts.\n   * @locus Server\n   * @param {Function} func Called whenever a login is attempted (either successful or unsuccessful).  A login can be aborted by returning a falsy value or throwing an exception.\n   */\n  validateLoginAttempt(func) {\n    // Exceptions inside the hook callback are passed up to us.\n    return this._validateLoginHook.register(func);\n  }\n\n  /**\n   * @summary Set restrictions on new user creation.\n   * @locus Server\n   * @param {Function} func Called whenever a new user is created. Takes the new user object, and returns true to allow the creation or false to abort.\n   */\n  validateNewUser(func) {\n    this._validateNewUserHooks.push(func);\n  }\n\n  /**\n   * @summary Validate login from external service\n   * @locus Server\n   * @param {Function} func Called whenever login/user creation from external service is attempted. Login or user creation based on this login can be aborted by passing a falsy value or throwing an exception.\n   */\n  beforeExternalLogin(func) {\n    if (this._beforeExternalLoginHook) {\n      throw new Error(\"Can only call beforeExternalLogin once\");\n    }\n\n    this._beforeExternalLoginHook = func;\n  }\n\n  ///\n  /// CREATE USER HOOKS\n  ///\n\n  /**\n   * @summary Customize login token creation.\n   * @locus Server\n   * @param {Function} func Called whenever a new token is created.\n   * Return the sequence and the user object. Return true to keep sending the default email, or false to override the behavior.\n   */\n  onCreateLoginToken = function(func) {\n    if (this._onCreateLoginTokenHook) {\n      throw new Error('Can only call onCreateLoginToken once');\n    }\n\n    this._onCreateLoginTokenHook = func;\n  };\n\n  /**\n   * @summary Customize new user creation.\n   * @locus Server\n   * @param {Function} func Called whenever a new user is created. Return the new user object, or throw an `Error` to abort the creation.\n   */\n  onCreateUser(func) {\n    if (this._onCreateUserHook) {\n      throw new Error(\"Can only call onCreateUser once\");\n    }\n\n    this._onCreateUserHook = Meteor.wrapFn(func);\n  }\n\n  /**\n   * @summary Customize oauth user profile updates\n   * @locus Server\n   * @param {Function} func Called whenever a user is logged in via oauth. Return the profile object to be merged, or throw an `Error` to abort the creation.\n   */\n  onExternalLogin(func) {\n    if (this._onExternalLoginHook) {\n      throw new Error(\"Can only call onExternalLogin once\");\n    }\n\n    this._onExternalLoginHook = func;\n  }\n\n  /**\n   * @summary Customize user selection on external logins\n   * @locus Server\n   * @param {Function} func Called whenever a user is logged in via oauth and a\n   * user is not found with the service id. Return the user or undefined.\n   */\n  setAdditionalFindUserOnExternalLogin(func) {\n    if (this._additionalFindUserOnExternalLogin) {\n      throw new Error(\"Can only call setAdditionalFindUserOnExternalLogin once\");\n    }\n    this._additionalFindUserOnExternalLogin = func;\n  }\n\n  _validateLogin(connection, attempt) {\n    this._validateLoginHook.forEach(callback => {\n      let ret;\n      try {\n        ret = callback(cloneAttemptWithConnection(connection, attempt));\n      }\n      catch (e) {\n        attempt.allowed = false;\n        // XXX this means the last thrown error overrides previous error\n        // messages. Maybe this is surprising to users and we should make\n        // overriding errors more explicit. (see\n        // https://github.com/meteor/meteor/issues/1960)\n        attempt.error = e;\n        return true;\n      }\n      if (! ret) {\n        attempt.allowed = false;\n        // don't override a specific error provided by a previous\n        // validator or the initial attempt (eg \"incorrect password\").\n        if (!attempt.error)\n          attempt.error = new Meteor.Error(403, \"Login forbidden\");\n      }\n      return true;\n    });\n  };\n\n  _successfulLogin(connection, attempt) {\n    this._onLoginHook.each(callback => {\n      callback(cloneAttemptWithConnection(connection, attempt));\n      return true;\n    });\n  };\n\n  _failedLogin(connection, attempt) {\n    this._onLoginFailureHook.each(callback => {\n      callback(cloneAttemptWithConnection(connection, attempt));\n      return true;\n    });\n  };\n\n  _successfulLogout(connection, userId) {\n    // don't fetch the user object unless there are some callbacks registered\n    let user;\n    this._onLogoutHook.each(callback => {\n      if (!user && userId) user = this.users.findOne(userId, {fields: this._options.defaultFieldSelector});\n      callback({ user, connection });\n      return true;\n    });\n  };\n\n  // Generates a MongoDB selector that can be used to perform a fast case\n  // insensitive lookup for the given fieldName and string. Since MongoDB does\n  // not support case insensitive indexes, and case insensitive regex queries\n  // are slow, we construct a set of prefix selectors for all permutations of\n  // the first 4 characters ourselves. We first attempt to matching against\n  // these, and because 'prefix expression' regex queries do use indexes (see\n  // http://docs.mongodb.org/v2.6/reference/operator/query/regex/#index-use),\n  // this has been found to greatly improve performance (from 1200ms to 5ms in a\n  // test with 1.000.000 users).\n  _selectorForFastCaseInsensitiveLookup = (fieldName, string) => {\n    // Performance seems to improve up to 4 prefix characters\n    const prefix = string.substring(0, Math.min(string.length, 4));\n    const orClause = generateCasePermutationsForString(prefix).map(\n        prefixPermutation => {\n          const selector = {};\n          selector[fieldName] =\n              new RegExp(`^${Meteor._escapeRegExp(prefixPermutation)}`);\n          return selector;\n        });\n    const caseInsensitiveClause = {};\n    caseInsensitiveClause[fieldName] =\n        new RegExp(`^${Meteor._escapeRegExp(string)}$`, 'i')\n    return {$and: [{$or: orClause}, caseInsensitiveClause]};\n  }\n\n  _findUserByQuery = (query, options) => {\n    let user = null;\n\n    if (query.id) {\n      // default field selector is added within getUserById()\n      user = Meteor.users.findOne(query.id, this._addDefaultFieldSelector(options));\n    } else {\n      options = this._addDefaultFieldSelector(options);\n      let fieldName;\n      let fieldValue;\n      if (query.username) {\n        fieldName = 'username';\n        fieldValue = query.username;\n      } else if (query.email) {\n        fieldName = 'emails.address';\n        fieldValue = query.email;\n      } else {\n        throw new Error(\"shouldn't happen (validation missed something)\");\n      }\n      let selector = {};\n      selector[fieldName] = fieldValue;\n      user = Meteor.users.findOne(selector, options);\n      // If user is not found, try a case insensitive lookup\n      if (!user) {\n        selector = this._selectorForFastCaseInsensitiveLookup(fieldName, fieldValue);\n        const candidateUsers = Meteor.users.find(selector, { ...options, limit: 2 }).fetch();\n        // No match if multiple candidates are found\n        if (candidateUsers.length === 1) {\n          user = candidateUsers[0];\n        }\n      }\n    }\n\n    return user;\n  }\n\n  ///\n  /// LOGIN METHODS\n  ///\n\n  // Login methods return to the client an object containing these\n  // fields when the user was logged in successfully:\n  //\n  //   id: userId\n  //   token: *\n  //   tokenExpires: *\n  //\n  // tokenExpires is optional and intends to provide a hint to the\n  // client as to when the token will expire. If not provided, the\n  // client will call Accounts._tokenExpiration, passing it the date\n  // that it received the token.\n  //\n  // The login method will throw an error back to the client if the user\n  // failed to log in.\n  //\n  //\n  // Login handlers and service specific login methods such as\n  // `createUser` internally return a `result` object containing these\n  // fields:\n  //\n  //   type:\n  //     optional string; the service name, overrides the handler\n  //     default if present.\n  //\n  //   error:\n  //     exception; if the user is not allowed to login, the reason why.\n  //\n  //   userId:\n  //     string; the user id of the user attempting to login (if\n  //     known), required for an allowed login.\n  //\n  //   options:\n  //     optional object merged into the result returned by the login\n  //     method; used by HAMK from SRP.\n  //\n  //   stampedLoginToken:\n  //     optional object with `token` and `when` indicating the login\n  //     token is already present in the database, returned by the\n  //     \"resume\" login handler.\n  //\n  // For convenience, login methods can also throw an exception, which\n  // is converted into an {error} result.  However, if the id of the\n  // user attempting the login is known, a {userId, error} result should\n  // be returned instead since the user id is not captured when an\n  // exception is thrown.\n  //\n  // This internal `result` object is automatically converted into the\n  // public {id, token, tokenExpires} object returned to the client.\n\n  // Try a login method, converting thrown exceptions into an {error}\n  // result.  The `type` argument is a default, inserted into the result\n  // object if not explicitly returned.\n  //\n  // Log in a user on a connection.\n  //\n  // We use the method invocation to set the user id on the connection,\n  // not the connection object directly. setUserId is tied to methods to\n  // enforce clear ordering of method application (using wait methods on\n  // the client, and a no setUserId after unblock restriction on the\n  // server)\n  //\n  // The `stampedLoginToken` parameter is optional.  When present, it\n  // indicates that the login token has already been inserted into the\n  // database and doesn't need to be inserted again.  (It's used by the\n  // \"resume\" login handler).\n  _loginUser(methodInvocation, userId, stampedLoginToken) {\n    if (! stampedLoginToken) {\n      stampedLoginToken = this._generateStampedLoginToken();\n      this._insertLoginToken(userId, stampedLoginToken);\n    }\n\n    // This order (and the avoidance of yields) is important to make\n    // sure that when publish functions are rerun, they see a\n    // consistent view of the world: the userId is set and matches\n    // the login token on the connection (not that there is\n    // currently a public API for reading the login token on a\n    // connection).\n    Meteor._noYieldsAllowed(() =>\n      this._setLoginToken(\n        userId,\n        methodInvocation.connection,\n        this._hashLoginToken(stampedLoginToken.token)\n      )\n    );\n\n    methodInvocation.setUserId(userId);\n\n    return {\n      id: userId,\n      token: stampedLoginToken.token,\n      tokenExpires: this._tokenExpiration(stampedLoginToken.when)\n    };\n  };\n\n  // After a login method has completed, call the login hooks.  Note\n  // that `attemptLogin` is called for *all* login attempts, even ones\n  // which aren't successful (such as an invalid password, etc).\n  //\n  // If the login is allowed and isn't aborted by a validate login hook\n  // callback, log in the user.\n  //\n  async _attemptLogin(\n    methodInvocation,\n    methodName,\n    methodArgs,\n    result\n  ) {\n    if (!result)\n      throw new Error(\"result is required\");\n\n    // XXX A programming error in a login handler can lead to this occurring, and\n    // then we don't call onLogin or onLoginFailure callbacks. Should\n    // tryLoginMethod catch this case and turn it into an error?\n    if (!result.userId && !result.error)\n      throw new Error(\"A login method must specify a userId or an error\");\n\n    let user;\n    if (result.userId)\n      user = this.users.findOne(result.userId, {fields: this._options.defaultFieldSelector});\n\n    const attempt = {\n      type: result.type || \"unknown\",\n      allowed: !! (result.userId && !result.error),\n      methodName: methodName,\n      methodArguments: Array.from(methodArgs)\n    };\n    if (result.error) {\n      attempt.error = result.error;\n    }\n    if (user) {\n      attempt.user = user;\n    }\n\n    // _validateLogin may mutate `attempt` by adding an error and changing allowed\n    // to false, but that's the only change it can make (and the user's callbacks\n    // only get a clone of `attempt`).\n    this._validateLogin(methodInvocation.connection, attempt);\n\n    if (attempt.allowed) {\n      const ret = {\n        ...this._loginUser(\n          methodInvocation,\n          result.userId,\n          result.stampedLoginToken\n        ),\n        ...result.options\n      };\n      ret.type = attempt.type;\n      this._successfulLogin(methodInvocation.connection, attempt);\n      return ret;\n    }\n    else {\n      this._failedLogin(methodInvocation.connection, attempt);\n      throw attempt.error;\n    }\n  };\n\n  // All service specific login methods should go through this function.\n  // Ensure that thrown exceptions are caught and that login hook\n  // callbacks are still called.\n  //\n  async _loginMethod(\n    methodInvocation,\n    methodName,\n    methodArgs,\n    type,\n    fn\n  ) {\n    return await this._attemptLogin(\n      methodInvocation,\n      methodName,\n      methodArgs,\n      await tryLoginMethod(type, fn)\n    );\n  };\n\n\n  // Report a login attempt failed outside the context of a normal login\n  // method. This is for use in the case where there is a multi-step login\n  // procedure (eg SRP based password login). If a method early in the\n  // chain fails, it should call this function to report a failure. There\n  // is no corresponding method for a successful login; methods that can\n  // succeed at logging a user in should always be actual login methods\n  // (using either Accounts._loginMethod or Accounts.registerLoginHandler).\n  _reportLoginFailure(\n    methodInvocation,\n    methodName,\n    methodArgs,\n    result\n  ) {\n    const attempt = {\n      type: result.type || \"unknown\",\n      allowed: false,\n      error: result.error,\n      methodName: methodName,\n      methodArguments: Array.from(methodArgs)\n    };\n\n    if (result.userId) {\n      attempt.user = this.users.findOne(result.userId, {fields: this._options.defaultFieldSelector});\n    }\n\n    this._validateLogin(methodInvocation.connection, attempt);\n    this._failedLogin(methodInvocation.connection, attempt);\n\n    // _validateLogin may mutate attempt to set a new error message. Return\n    // the modified version.\n    return attempt;\n  };\n\n  ///\n  /// LOGIN HANDLERS\n  ///\n\n  /**\n   * @summary Registers a new login handler.\n   * @locus Server\n   * @param {String} [name] The type of login method like oauth, password, etc.\n   * @param {Function} handler A function that receives an options object\n   * (as passed as an argument to the `login` method) and returns one of\n   * `undefined`, meaning don't handle or a login method result object.\n   */\n  registerLoginHandler(name, handler) {\n    if (! handler) {\n      handler = name;\n      name = null;\n    }\n\n    this._loginHandlers.push({\n      name: name,\n      handler: Meteor.wrapFn(handler)\n    });\n  };\n\n\n  // Checks a user's credentials against all the registered login\n  // handlers, and returns a login token if the credentials are valid. It\n  // is like the login method, except that it doesn't set the logged-in\n  // user on the connection. Throws a Meteor.Error if logging in fails,\n  // including the case where none of the login handlers handled the login\n  // request. Otherwise, returns {id: userId, token: *, tokenExpires: *}.\n  //\n  // For example, if you want to login with a plaintext password, `options` could be\n  //   { user: { username: <username> }, password: <password> }, or\n  //   { user: { email: <email> }, password: <password> }.\n\n  // Try all of the registered login handlers until one of them doesn't\n  // return `undefined`, meaning it handled this call to `login`. Return\n  // that return value.\n  async _runLoginHandlers(methodInvocation, options) {\n    for (let handler of this._loginHandlers) {\n      const result = await tryLoginMethod(handler.name, async () =>\n        await handler.handler.call(methodInvocation, options)\n      );\n\n      if (result) {\n        return result;\n      }\n\n      if (result !== undefined) {\n        throw new Meteor.Error(\n          400,\n          'A login handler should return a result or undefined'\n        );\n      }\n    }\n\n    return {\n      type: null,\n      error: new Meteor.Error(400, \"Unrecognized options for login request\")\n    };\n  };\n\n  // Deletes the given loginToken from the database.\n  //\n  // For new-style hashed token, this will cause all connections\n  // associated with the token to be closed.\n  //\n  // Any connections associated with old-style unhashed tokens will be\n  // in the process of becoming associated with hashed tokens and then\n  // they'll get closed.\n  destroyToken(userId, loginToken) {\n    this.users.update(userId, {\n      $pull: {\n        \"services.resume.loginTokens\": {\n          $or: [\n            { hashedToken: loginToken },\n            { token: loginToken }\n          ]\n        }\n      }\n    });\n  };\n\n  _initServerMethods() {\n    // The methods created in this function need to be created here so that\n    // this variable is available in their scope.\n    const accounts = this;\n\n\n    // This object will be populated with methods and then passed to\n    // accounts._server.methods further below.\n    const methods = {};\n\n    // @returns {Object|null}\n    //   If successful, returns {token: reconnectToken, id: userId}\n    //   If unsuccessful (for example, if the user closed the oauth login popup),\n    //     throws an error describing the reason\n    methods.login = async function (options) {\n      // Login handlers should really also check whatever field they look at in\n      // options, but we don't enforce it.\n      check(options, Object);\n\n      const result = await accounts._runLoginHandlers(this, options);\n      //console.log({result});\n\n      return await accounts._attemptLogin(this, \"login\", arguments, result);\n    };\n\n    methods.logout = function () {\n      const token = accounts._getLoginToken(this.connection.id);\n      accounts._setLoginToken(this.userId, this.connection, null);\n      if (token && this.userId) {\n        accounts.destroyToken(this.userId, token);\n      }\n      accounts._successfulLogout(this.connection, this.userId);\n      this.setUserId(null);\n    };\n\n    // Generates a new login token with the same expiration as the\n    // connection's current token and saves it to the database. Associates\n    // the connection with this new token and returns it. Throws an error\n    // if called on a connection that isn't logged in.\n    //\n    // @returns Object\n    //   If successful, returns { token: <new token>, id: <user id>,\n    //   tokenExpires: <expiration date> }.\n    methods.getNewToken = function () {\n      const user = accounts.users.findOne(this.userId, {\n        fields: { \"services.resume.loginTokens\": 1 }\n      });\n      if (! this.userId || ! user) {\n        throw new Meteor.Error(\"You are not logged in.\");\n      }\n      // Be careful not to generate a new token that has a later\n      // expiration than the curren token. Otherwise, a bad guy with a\n      // stolen token could use this method to stop his stolen token from\n      // ever expiring.\n      const currentHashedToken = accounts._getLoginToken(this.connection.id);\n      const currentStampedToken = user.services.resume.loginTokens.find(\n        stampedToken => stampedToken.hashedToken === currentHashedToken\n      );\n      if (! currentStampedToken) { // safety belt: this should never happen\n        throw new Meteor.Error(\"Invalid login token\");\n      }\n      const newStampedToken = accounts._generateStampedLoginToken();\n      newStampedToken.when = currentStampedToken.when;\n      accounts._insertLoginToken(this.userId, newStampedToken);\n      return accounts._loginUser(this, this.userId, newStampedToken);\n    };\n\n    // Removes all tokens except the token associated with the current\n    // connection. Throws an error if the connection is not logged\n    // in. Returns nothing on success.\n    methods.removeOtherTokens = function () {\n      if (! this.userId) {\n        throw new Meteor.Error(\"You are not logged in.\");\n      }\n      const currentToken = accounts._getLoginToken(this.connection.id);\n      accounts.users.update(this.userId, {\n        $pull: {\n          \"services.resume.loginTokens\": { hashedToken: { $ne: currentToken } }\n        }\n      });\n    };\n\n    // Allow a one-time configuration for a login service. Modifications\n    // to this collection are also allowed in insecure mode.\n    methods.configureLoginService = (options) => {\n      check(options, Match.ObjectIncluding({service: String}));\n      // Don't let random users configure a service we haven't added yet (so\n      // that when we do later add it, it's set up with their configuration\n      // instead of ours).\n      // XXX if service configuration is oauth-specific then this code should\n      //     be in accounts-oauth; if it's not then the registry should be\n      //     in this package\n      if (!(accounts.oauth\n        && accounts.oauth.serviceNames().includes(options.service))) {\n        throw new Meteor.Error(403, \"Service unknown\");\n      }\n\n      if (Package['service-configuration']) {\n        const { ServiceConfiguration } = Package['service-configuration'];\n        if (ServiceConfiguration.configurations.findOne({service: options.service}))\n          throw new Meteor.Error(403, `Service ${options.service} already configured`);\n\n        if (Package[\"oauth-encryption\"]) {\n          const { OAuthEncryption } = Package[\"oauth-encryption\"]\n          if (hasOwn.call(options, 'secret') && OAuthEncryption.keyIsLoaded())\n            options.secret = OAuthEncryption.seal(options.secret);\n        }\n\n        ServiceConfiguration.configurations.insert(options);\n      }\n    };\n\n    accounts._server.methods(methods);\n  };\n\n  _initAccountDataHooks() {\n    this._server.onConnection(connection => {\n      this._accountData[connection.id] = {\n        connection: connection\n      };\n\n      connection.onClose(() => {\n        this._removeTokenFromConnection(connection.id);\n        delete this._accountData[connection.id];\n      });\n    });\n  };\n\n  _initServerPublications() {\n    // Bring into lexical scope for publish callbacks that need `this`\n    const { users, _autopublishFields, _defaultPublishFields } = this;\n\n    // Publish all login service configuration fields other than secret.\n    this._server.publish(\"meteor.loginServiceConfiguration\", function() {\n      if (Package['service-configuration']) {\n        const { ServiceConfiguration } = Package['service-configuration'];\n        return ServiceConfiguration.configurations.find({}, {fields: {secret: 0}});\n      }\n      this.ready();\n    }, {is_auto: true}); // not technically autopublish, but stops the warning.\n\n    // Use Meteor.startup to give other packages a chance to call\n    // setDefaultPublishFields.\n    Meteor.startup(() => {\n      // Merge custom fields selector and default publish fields so that the client\n      // gets all the necessary fields to run properly\n      const customFields = this._addDefaultFieldSelector().fields || {};\n      const keys = Object.keys(customFields);\n      // If the custom fields are negative, then ignore them and only send the necessary fields\n      const fields = keys.length > 0 && customFields[keys[0]] ? {\n        ...this._addDefaultFieldSelector().fields,\n        ..._defaultPublishFields.projection\n      } : _defaultPublishFields.projection\n      // Publish the current user's record to the client.\n      this._server.publish(null, function () {\n        if (this.userId) {\n          return users.find({\n            _id: this.userId\n          }, {\n            fields,\n          });\n        } else {\n          return null;\n        }\n      }, /*suppress autopublish warning*/{is_auto: true});\n    });\n\n    // Use Meteor.startup to give other packages a chance to call\n    // addAutopublishFields.\n    Package.autopublish && Meteor.startup(() => {\n      // ['profile', 'username'] -> {profile: 1, username: 1}\n      const toFieldSelector = fields => fields.reduce((prev, field) => (\n          { ...prev, [field]: 1 }),\n        {}\n      );\n      this._server.publish(null, function () {\n        if (this.userId) {\n          return users.find({ _id: this.userId }, {\n            fields: toFieldSelector(_autopublishFields.loggedInUser),\n          })\n        } else {\n          return null;\n        }\n      }, /*suppress autopublish warning*/{is_auto: true});\n\n      // XXX this publish is neither dedup-able nor is it optimized by our special\n      // treatment of queries on a specific _id. Therefore this will have O(n^2)\n      // run-time performance every time a user document is changed (eg someone\n      // logging in). If this is a problem, we can instead write a manual publish\n      // function which filters out fields based on 'this.userId'.\n      this._server.publish(null, function () {\n        const selector = this.userId ? { _id: { $ne: this.userId } } : {};\n        return users.find(selector, {\n          fields: toFieldSelector(_autopublishFields.otherUsers),\n        })\n      }, /*suppress autopublish warning*/{is_auto: true});\n    });\n  };\n\n  // Add to the list of fields or subfields to be automatically\n  // published if autopublish is on. Must be called from top-level\n  // code (ie, before Meteor.startup hooks run).\n  //\n  // @param opts {Object} with:\n  //   - forLoggedInUser {Array} Array of fields published to the logged-in user\n  //   - forOtherUsers {Array} Array of fields published to users that aren't logged in\n  addAutopublishFields(opts) {\n    this._autopublishFields.loggedInUser.push.apply(\n      this._autopublishFields.loggedInUser, opts.forLoggedInUser);\n    this._autopublishFields.otherUsers.push.apply(\n      this._autopublishFields.otherUsers, opts.forOtherUsers);\n  };\n\n  // Replaces the fields to be automatically\n  // published when the user logs in\n  //\n  // @param {MongoFieldSpecifier} fields Dictionary of fields to return or exclude.\n  setDefaultPublishFields(fields) {\n    this._defaultPublishFields.projection = fields;\n  };\n\n  ///\n  /// ACCOUNT DATA\n  ///\n\n  // HACK: This is used by 'meteor-accounts' to get the loginToken for a\n  // connection. Maybe there should be a public way to do that.\n  _getAccountData(connectionId, field) {\n    const data = this._accountData[connectionId];\n    return data && data[field];\n  };\n\n  _setAccountData(connectionId, field, value) {\n    const data = this._accountData[connectionId];\n\n    // safety belt. shouldn't happen. accountData is set in onConnection,\n    // we don't have a connectionId until it is set.\n    if (!data)\n      return;\n\n    if (value === undefined)\n      delete data[field];\n    else\n      data[field] = value;\n  };\n\n  ///\n  /// RECONNECT TOKENS\n  ///\n  /// support reconnecting using a meteor login token\n\n  _hashLoginToken(loginToken) {\n    const hash = crypto.createHash('sha256');\n    hash.update(loginToken);\n    return hash.digest('base64');\n  };\n\n  // {token, when} => {hashedToken, when}\n  _hashStampedToken(stampedToken) {\n    const { token, ...hashedStampedToken } = stampedToken;\n    return {\n      ...hashedStampedToken,\n      hashedToken: this._hashLoginToken(token)\n    };\n  };\n\n  // Using $addToSet avoids getting an index error if another client\n  // logging in simultaneously has already inserted the new hashed\n  // token.\n  _insertHashedLoginToken(userId, hashedToken, query) {\n    query = query ? { ...query } : {};\n    query._id = userId;\n    this.users.update(query, {\n      $addToSet: {\n        \"services.resume.loginTokens\": hashedToken\n      }\n    });\n  };\n\n  // Exported for tests.\n  _insertLoginToken(userId, stampedToken, query) {\n    this._insertHashedLoginToken(\n      userId,\n      this._hashStampedToken(stampedToken),\n      query\n    );\n  };\n\n  _clearAllLoginTokens(userId) {\n    this.users.update(userId, {\n      $set: {\n        'services.resume.loginTokens': []\n      }\n    });\n  };\n\n  // test hook\n  _getUserObserve(connectionId) {\n    return this._userObservesForConnections[connectionId];\n  };\n\n  // Clean up this connection's association with the token: that is, stop\n  // the observe that we started when we associated the connection with\n  // this token.\n  _removeTokenFromConnection(connectionId) {\n    if (hasOwn.call(this._userObservesForConnections, connectionId)) {\n      const observe = this._userObservesForConnections[connectionId];\n      if (typeof observe === 'number') {\n        // We're in the process of setting up an observe for this connection. We\n        // can't clean up that observe yet, but if we delete the placeholder for\n        // this connection, then the observe will get cleaned up as soon as it has\n        // been set up.\n        delete this._userObservesForConnections[connectionId];\n      } else {\n        delete this._userObservesForConnections[connectionId];\n        observe.stop();\n      }\n    }\n  };\n\n  _getLoginToken(connectionId) {\n    return this._getAccountData(connectionId, 'loginToken');\n  };\n\n  // newToken is a hashed token.\n  _setLoginToken(userId, connection, newToken) {\n    this._removeTokenFromConnection(connection.id);\n    this._setAccountData(connection.id, 'loginToken', newToken);\n\n    if (newToken) {\n      // Set up an observe for this token. If the token goes away, we need\n      // to close the connection.  We defer the observe because there's\n      // no need for it to be on the critical path for login; we just need\n      // to ensure that the connection will get closed at some point if\n      // the token gets deleted.\n      //\n      // Initially, we set the observe for this connection to a number; this\n      // signifies to other code (which might run while we yield) that we are in\n      // the process of setting up an observe for this connection. Once the\n      // observe is ready to go, we replace the number with the real observe\n      // handle (unless the placeholder has been deleted or replaced by a\n      // different placehold number, signifying that the connection was closed\n      // already -- in this case we just clean up the observe that we started).\n      const myObserveNumber = ++this._nextUserObserveNumber;\n      this._userObservesForConnections[connection.id] = myObserveNumber;\n      Meteor.defer(() => {\n        // If something else happened on this connection in the meantime (it got\n        // closed, or another call to _setLoginToken happened), just do\n        // nothing. We don't need to start an observe for an old connection or old\n        // token.\n        if (this._userObservesForConnections[connection.id] !== myObserveNumber) {\n          return;\n        }\n\n        let foundMatchingUser;\n        // Because we upgrade unhashed login tokens to hashed tokens at\n        // login time, sessions will only be logged in with a hashed\n        // token. Thus we only need to observe hashed tokens here.\n        const observe = this.users.find({\n          _id: userId,\n          'services.resume.loginTokens.hashedToken': newToken\n        }, { fields: { _id: 1 } }).observeChanges({\n          added: () => {\n            foundMatchingUser = true;\n          },\n          removed: connection.close,\n          // The onClose callback for the connection takes care of\n          // cleaning up the observe handle and any other state we have\n          // lying around.\n        }, { nonMutatingCallbacks: true });\n\n        // If the user ran another login or logout command we were waiting for the\n        // defer or added to fire (ie, another call to _setLoginToken occurred),\n        // then we let the later one win (start an observe, etc) and just stop our\n        // observe now.\n        //\n        // Similarly, if the connection was already closed, then the onClose\n        // callback would have called _removeTokenFromConnection and there won't\n        // be an entry in _userObservesForConnections. We can stop the observe.\n        if (this._userObservesForConnections[connection.id] !== myObserveNumber) {\n          observe.stop();\n          return;\n        }\n\n        this._userObservesForConnections[connection.id] = observe;\n\n        if (! foundMatchingUser) {\n          // We've set up an observe on the user associated with `newToken`,\n          // so if the new token is removed from the database, we'll close\n          // the connection. But the token might have already been deleted\n          // before we set up the observe, which wouldn't have closed the\n          // connection because the observe wasn't running yet.\n          connection.close();\n        }\n      });\n    }\n  };\n\n  // (Also used by Meteor Accounts server and tests).\n  //\n  _generateStampedLoginToken() {\n    return {\n      token: Random.secret(),\n      when: new Date\n    };\n  };\n\n  ///\n  /// TOKEN EXPIRATION\n  ///\n\n  // Deletes expired password reset tokens from the database.\n  //\n  // Exported for tests. Also, the arguments are only used by\n  // tests. oldestValidDate is simulate expiring tokens without waiting\n  // for them to actually expire. userId is used by tests to only expire\n  // tokens for the test user.\n  _expirePasswordResetTokens(oldestValidDate, userId) {\n    const tokenLifetimeMs = this._getPasswordResetTokenLifetimeMs();\n\n    // when calling from a test with extra arguments, you must specify both!\n    if ((oldestValidDate && !userId) || (!oldestValidDate && userId)) {\n      throw new Error(\"Bad test. Must specify both oldestValidDate and userId.\");\n    }\n\n    oldestValidDate = oldestValidDate ||\n      (new Date(new Date() - tokenLifetimeMs));\n\n    const tokenFilter = {\n      $or: [\n        { \"services.password.reset.reason\": \"reset\"},\n        { \"services.password.reset.reason\": {$exists: false}}\n      ]\n    };\n\n    expirePasswordToken(this, oldestValidDate, tokenFilter, userId);\n  }\n\n  // Deletes expired password enroll tokens from the database.\n  //\n  // Exported for tests. Also, the arguments are only used by\n  // tests. oldestValidDate is simulate expiring tokens without waiting\n  // for them to actually expire. userId is used by tests to only expire\n  // tokens for the test user.\n  _expirePasswordEnrollTokens(oldestValidDate, userId) {\n    const tokenLifetimeMs = this._getPasswordEnrollTokenLifetimeMs();\n\n    // when calling from a test with extra arguments, you must specify both!\n    if ((oldestValidDate && !userId) || (!oldestValidDate && userId)) {\n      throw new Error(\"Bad test. Must specify both oldestValidDate and userId.\");\n    }\n\n    oldestValidDate = oldestValidDate ||\n      (new Date(new Date() - tokenLifetimeMs));\n\n    const tokenFilter = {\n      \"services.password.enroll.reason\": \"enroll\"\n    };\n\n    expirePasswordToken(this, oldestValidDate, tokenFilter, userId);\n  }\n\n  // Deletes expired tokens from the database and closes all open connections\n  // associated with these tokens.\n  //\n  // Exported for tests. Also, the arguments are only used by\n  // tests. oldestValidDate is simulate expiring tokens without waiting\n  // for them to actually expire. userId is used by tests to only expire\n  // tokens for the test user.\n  _expireTokens(oldestValidDate, userId) {\n    const tokenLifetimeMs = this._getTokenLifetimeMs();\n\n    // when calling from a test with extra arguments, you must specify both!\n    if ((oldestValidDate && !userId) || (!oldestValidDate && userId)) {\n      throw new Error(\"Bad test. Must specify both oldestValidDate and userId.\");\n    }\n\n    oldestValidDate = oldestValidDate ||\n      (new Date(new Date() - tokenLifetimeMs));\n    const userFilter = userId ? {_id: userId} : {};\n\n\n    // Backwards compatible with older versions of meteor that stored login token\n    // timestamps as numbers.\n    this.users.update({ ...userFilter,\n      $or: [\n        { \"services.resume.loginTokens.when\": { $lt: oldestValidDate } },\n        { \"services.resume.loginTokens.when\": { $lt: +oldestValidDate } }\n      ]\n    }, {\n      $pull: {\n        \"services.resume.loginTokens\": {\n          $or: [\n            { when: { $lt: oldestValidDate } },\n            { when: { $lt: +oldestValidDate } }\n          ]\n        }\n      }\n    }, { multi: true });\n    // The observe on Meteor.users will take care of closing connections for\n    // expired tokens.\n  };\n\n  // @override from accounts_common.js\n  config(options) {\n    // Call the overridden implementation of the method.\n    const superResult = AccountsCommon.prototype.config.apply(this, arguments);\n\n    // If the user set loginExpirationInDays to null, then we need to clear the\n    // timer that periodically expires tokens.\n    if (hasOwn.call(this._options, 'loginExpirationInDays') &&\n      this._options.loginExpirationInDays === null &&\n      this.expireTokenInterval) {\n      Meteor.clearInterval(this.expireTokenInterval);\n      this.expireTokenInterval = null;\n    }\n\n    return superResult;\n  };\n\n  // Called by accounts-password\n  insertUserDoc(options, user) {\n    // - clone user document, to protect from modification\n    // - add createdAt timestamp\n    // - prepare an _id, so that you can modify other collections (eg\n    // create a first task for every new user)\n    //\n    // XXX If the onCreateUser or validateNewUser hooks fail, we might\n    // end up having modified some other collection\n    // inappropriately. The solution is probably to have onCreateUser\n    // accept two callbacks - one that gets called before inserting\n    // the user document (in which you can modify its contents), and\n    // one that gets called after (in which you should change other\n    // collections)\n    user = {\n      createdAt: new Date(),\n      _id: Random.id(),\n      ...user,\n    };\n\n    if (user.services) {\n      Object.keys(user.services).forEach(service =>\n        pinEncryptedFieldsToUser(user.services[service], user._id)\n      );\n    }\n\n    let fullUser;\n    if (this._onCreateUserHook) {\n      fullUser = this._onCreateUserHook(options, user);\n\n      // This is *not* part of the API. We need this because we can't isolate\n      // the global server environment between tests, meaning we can't test\n      // both having a create user hook set and not having one set.\n      if (fullUser === 'TEST DEFAULT HOOK')\n        fullUser = defaultCreateUserHook(options, user);\n    } else {\n      fullUser = defaultCreateUserHook(options, user);\n    }\n\n    this._validateNewUserHooks.forEach(hook => {\n      if (! hook(fullUser))\n        throw new Meteor.Error(403, \"User validation failed\");\n    });\n\n    let userId;\n    try {\n      userId = this.users.insert(fullUser);\n    } catch (e) {\n      // XXX string parsing sucks, maybe\n      // https://jira.mongodb.org/browse/SERVER-3069 will get fixed one day\n      // https://jira.mongodb.org/browse/SERVER-4637\n      if (!e.errmsg) throw e;\n      if (e.errmsg.includes('emails.address'))\n        throw new Meteor.Error(403, \"Email already exists.\");\n      if (e.errmsg.includes('username'))\n        throw new Meteor.Error(403, \"Username already exists.\");\n      throw e;\n    }\n    return userId;\n  };\n\n  // Helper function: returns false if email does not match company domain from\n  // the configuration.\n  _testEmailDomain(email) {\n    const domain = this._options.restrictCreationByEmailDomain;\n\n    return !domain ||\n      (typeof domain === 'function' && domain(email)) ||\n      (typeof domain === 'string' &&\n        (new RegExp(`@${Meteor._escapeRegExp(domain)}$`, 'i')).test(email));\n  };\n\n  ///\n  /// CLEAN UP FOR `logoutOtherClients`\n  ///\n\n  _deleteSavedTokensForUser(userId, tokensToDelete) {\n    if (tokensToDelete) {\n      this.users.update(userId, {\n        $unset: {\n          \"services.resume.haveLoginTokensToDelete\": 1,\n          \"services.resume.loginTokensToDelete\": 1\n        },\n        $pullAll: {\n          \"services.resume.loginTokens\": tokensToDelete\n        }\n      });\n    }\n  };\n\n  _deleteSavedTokensForAllUsersOnStartup() {\n    // If we find users who have saved tokens to delete on startup, delete\n    // them now. It's possible that the server could have crashed and come\n    // back up before new tokens are found in localStorage, but this\n    // shouldn't happen very often. We shouldn't put a delay here because\n    // that would give a lot of power to an attacker with a stolen login\n    // token and the ability to crash the server.\n    Meteor.startup(() => {\n      this.users.find({\n        \"services.resume.haveLoginTokensToDelete\": true\n      }, {fields: {\n          \"services.resume.loginTokensToDelete\": 1\n        }}).forEach(user => {\n        this._deleteSavedTokensForUser(\n          user._id,\n          user.services.resume.loginTokensToDelete\n        );\n      });\n    });\n  };\n\n  ///\n  /// MANAGING USER OBJECTS\n  ///\n\n  // Updates or creates a user after we authenticate with a 3rd party.\n  //\n  // @param serviceName {String} Service name (eg, twitter).\n  // @param serviceData {Object} Data to store in the user's record\n  //        under services[serviceName]. Must include an \"id\" field\n  //        which is a unique identifier for the user in the service.\n  // @param options {Object, optional} Other options to pass to insertUserDoc\n  //        (eg, profile)\n  // @returns {Object} Object with token and id keys, like the result\n  //        of the \"login\" method.\n  //\n  updateOrCreateUserFromExternalService(\n    serviceName,\n    serviceData,\n    options\n  ) {\n    options = { ...options };\n\n    if (serviceName === \"password\" || serviceName === \"resume\") {\n      throw new Error(\n        \"Can't use updateOrCreateUserFromExternalService with internal service \"\n        + serviceName);\n    }\n    if (!hasOwn.call(serviceData, 'id')) {\n      throw new Error(\n        `Service data for service ${serviceName} must include id`);\n    }\n\n    // Look for a user with the appropriate service user id.\n    const selector = {};\n    const serviceIdKey = `services.${serviceName}.id`;\n\n    // XXX Temporary special case for Twitter. (Issue #629)\n    //   The serviceData.id will be a string representation of an integer.\n    //   We want it to match either a stored string or int representation.\n    //   This is to cater to earlier versions of Meteor storing twitter\n    //   user IDs in number form, and recent versions storing them as strings.\n    //   This can be removed once migration technology is in place, and twitter\n    //   users stored with integer IDs have been migrated to string IDs.\n    if (serviceName === \"twitter\" && !isNaN(serviceData.id)) {\n      selector[\"$or\"] = [{},{}];\n      selector[\"$or\"][0][serviceIdKey] = serviceData.id;\n      selector[\"$or\"][1][serviceIdKey] = parseInt(serviceData.id, 10);\n    } else {\n      selector[serviceIdKey] = serviceData.id;\n    }\n\n    let user = this.users.findOne(selector, {fields: this._options.defaultFieldSelector});\n\n    // Check to see if the developer has a custom way to find the user outside\n    // of the general selectors above.\n    if (!user && this._additionalFindUserOnExternalLogin) {\n      user = this._additionalFindUserOnExternalLogin({serviceName, serviceData, options})\n    }\n\n    // Before continuing, run user hook to see if we should continue\n    if (this._beforeExternalLoginHook && !this._beforeExternalLoginHook(serviceName, serviceData, user)) {\n      throw new Meteor.Error(403, \"Login forbidden\");\n    }\n\n    // When creating a new user we pass through all options. When updating an\n    // existing user, by default we only process/pass through the serviceData\n    // (eg, so that we keep an unexpired access token and don't cache old email\n    // addresses in serviceData.email). The onExternalLogin hook can be used when\n    // creating or updating a user, to modify or pass through more options as\n    // needed.\n    let opts = user ? {} : options;\n    if (this._onExternalLoginHook) {\n      opts = this._onExternalLoginHook(options, user);\n    }\n\n    if (user) {\n      pinEncryptedFieldsToUser(serviceData, user._id);\n\n      let setAttrs = {};\n      Object.keys(serviceData).forEach(key =>\n        setAttrs[`services.${serviceName}.${key}`] = serviceData[key]\n      );\n\n      // XXX Maybe we should re-use the selector above and notice if the update\n      //     touches nothing?\n      setAttrs = { ...setAttrs, ...opts };\n      this.users.update(user._id, {\n        $set: setAttrs\n      });\n\n      return {\n        type: serviceName,\n        userId: user._id\n      };\n    } else {\n      // Create a new user with the service data.\n      user = {services: {}};\n      user.services[serviceName] = serviceData;\n      return {\n        type: serviceName,\n        userId: this.insertUserDoc(opts, user)\n      };\n    }\n  };\n\n  // Removes default rate limiting rule\n  removeDefaultRateLimit() {\n    const resp = DDPRateLimiter.removeRule(this.defaultRateLimiterRuleId);\n    this.defaultRateLimiterRuleId = null;\n    return resp;\n  };\n\n  // Add a default rule of limiting logins, creating new users and password reset\n  // to 5 times every 10 seconds per connection.\n  addDefaultRateLimit() {\n    if (!this.defaultRateLimiterRuleId) {\n      this.defaultRateLimiterRuleId = DDPRateLimiter.addRule({\n        userId: null,\n        clientAddress: null,\n        type: 'method',\n        name: name => ['login', 'createUser', 'resetPassword', 'forgotPassword']\n          .includes(name),\n        connectionId: (connectionId) => true,\n      }, 5, 10000);\n    }\n  };\n\n  /**\n   * @summary Creates options for email sending for reset password and enroll account emails.\n   * You can use this function when customizing a reset password or enroll account email sending.\n   * @locus Server\n   * @param {Object} email Which address of the user's to send the email to.\n   * @param {Object} user The user object to generate options for.\n   * @param {String} url URL to which user is directed to confirm the email.\n   * @param {String} reason `resetPassword` or `enrollAccount`.\n   * @returns {Object} Options which can be passed to `Email.send`.\n   * @importFromPackage accounts-base\n   */\n  generateOptionsForEmail(email, user, url, reason, extra = {}){\n    const options = {\n      to: email,\n      from: this.emailTemplates[reason].from\n        ? this.emailTemplates[reason].from(user)\n        : this.emailTemplates.from,\n      subject: this.emailTemplates[reason].subject(user, url, extra),\n    };\n\n    if (typeof this.emailTemplates[reason].text === 'function') {\n      options.text = this.emailTemplates[reason].text(user, url, extra);\n    }\n\n    if (typeof this.emailTemplates[reason].html === 'function') {\n      options.html = this.emailTemplates[reason].html(user, url, extra);\n    }\n\n    if (typeof this.emailTemplates.headers === 'object') {\n      options.headers = this.emailTemplates.headers;\n    }\n\n    return options;\n  };\n\n  _checkForCaseInsensitiveDuplicates(\n    fieldName,\n    displayName,\n    fieldValue,\n    ownUserId\n  ) {\n    // Some tests need the ability to add users with the same case insensitive\n    // value, hence the _skipCaseInsensitiveChecksForTest check\n    const skipCheck = Object.prototype.hasOwnProperty.call(\n      this._skipCaseInsensitiveChecksForTest,\n      fieldValue\n    );\n\n    if (fieldValue && !skipCheck) {\n      const matchedUsers = Meteor.users\n        .find(\n          this._selectorForFastCaseInsensitiveLookup(fieldName, fieldValue),\n          {\n            fields: { _id: 1 },\n            // we only need a maximum of 2 users for the logic below to work\n            limit: 2,\n          }\n        )\n        .fetch();\n\n      if (\n        matchedUsers.length > 0 &&\n        // If we don't have a userId yet, any match we find is a duplicate\n        (!ownUserId ||\n          // Otherwise, check to see if there are multiple matches or a match\n          // that is not us\n          matchedUsers.length > 1 || matchedUsers[0]._id !== ownUserId)\n      ) {\n        this._handleError(`${displayName} already exists.`);\n      }\n    }\n  };\n\n  _createUserCheckingDuplicates({ user, email, username, options }) {\n    const newUser = {\n      ...user,\n      ...(username ? { username } : {}),\n      ...(email ? { emails: [{ address: email, verified: false }] } : {}),\n    };\n\n    // Perform a case insensitive check before insert\n    this._checkForCaseInsensitiveDuplicates('username', 'Username', username);\n    this._checkForCaseInsensitiveDuplicates('emails.address', 'Email', email);\n\n    const userId = this.insertUserDoc(options, newUser);\n    // Perform another check after insert, in case a matching user has been\n    // inserted in the meantime\n    try {\n      this._checkForCaseInsensitiveDuplicates('username', 'Username', username, userId);\n      this._checkForCaseInsensitiveDuplicates('emails.address', 'Email', email, userId);\n    } catch (ex) {\n      // Remove inserted user if the check fails\n      Meteor.users.remove(userId);\n      throw ex;\n    }\n    return userId;\n  }\n\n  _handleError = (msg, throwError = true, errorCode = 403) => {\n    const error = new Meteor.Error(\n      errorCode,\n      this._options.ambiguousErrorMessages\n        ? \"Something went wrong. Please check your credentials.\"\n        : msg\n    );\n    if (throwError) {\n      throw error;\n    }\n    return error;\n  }\n\n  _userQueryValidator = Match.Where(user => {\n    check(user, {\n      id: Match.Optional(NonEmptyString),\n      username: Match.Optional(NonEmptyString),\n      email: Match.Optional(NonEmptyString)\n    });\n    if (Object.keys(user).length !== 1)\n      throw new Match.Error(\"User property must have exactly one field\");\n    return true;\n  });\n\n}\n\n// Give each login hook callback a fresh cloned copy of the attempt\n// object, but don't clone the connection.\n//\nconst cloneAttemptWithConnection = (connection, attempt) => {\n  const clonedAttempt = EJSON.clone(attempt);\n  clonedAttempt.connection = connection;\n  return clonedAttempt;\n};\n\nconst tryLoginMethod = async (type, fn) => {\n  let result;\n  try {\n    result = await fn();\n  }\n  catch (e) {\n    result = {error: e};\n  }\n\n  if (result && !result.type && type)\n    result.type = type;\n\n  return result;\n};\n\nconst setupDefaultLoginHandlers = accounts => {\n  accounts.registerLoginHandler(\"resume\", function (options) {\n    return defaultResumeLoginHandler.call(this, accounts, options);\n  });\n};\n\n// Login handler for resume tokens.\nconst defaultResumeLoginHandler = (accounts, options) => {\n  if (!options.resume)\n    return undefined;\n\n  check(options.resume, String);\n\n  const hashedToken = accounts._hashLoginToken(options.resume);\n\n  // First look for just the new-style hashed login token, to avoid\n  // sending the unhashed token to the database in a query if we don't\n  // need to.\n  let user = accounts.users.findOne(\n    {\"services.resume.loginTokens.hashedToken\": hashedToken},\n    {fields: {\"services.resume.loginTokens.$\": 1}});\n\n  if (! user) {\n    // If we didn't find the hashed login token, try also looking for\n    // the old-style unhashed token.  But we need to look for either\n    // the old-style token OR the new-style token, because another\n    // client connection logging in simultaneously might have already\n    // converted the token.\n    user = accounts.users.findOne({\n        $or: [\n          {\"services.resume.loginTokens.hashedToken\": hashedToken},\n          {\"services.resume.loginTokens.token\": options.resume}\n        ]\n      },\n      // Note: Cannot use ...loginTokens.$ positional operator with $or query.\n      {fields: {\"services.resume.loginTokens\": 1}});\n  }\n\n  if (! user)\n    return {\n      error: new Meteor.Error(403, \"You've been logged out by the server. Please log in again.\")\n    };\n\n  // Find the token, which will either be an object with fields\n  // {hashedToken, when} for a hashed token or {token, when} for an\n  // unhashed token.\n  let oldUnhashedStyleToken;\n  let token = user.services.resume.loginTokens.find(token =>\n    token.hashedToken === hashedToken\n  );\n  if (token) {\n    oldUnhashedStyleToken = false;\n  } else {\n    token = user.services.resume.loginTokens.find(token =>\n      token.token === options.resume\n    );\n    oldUnhashedStyleToken = true;\n  }\n\n  const tokenExpires = accounts._tokenExpiration(token.when);\n  if (new Date() >= tokenExpires)\n    return {\n      userId: user._id,\n      error: new Meteor.Error(403, \"Your session has expired. Please log in again.\")\n    };\n\n  // Update to a hashed token when an unhashed token is encountered.\n  if (oldUnhashedStyleToken) {\n    // Only add the new hashed token if the old unhashed token still\n    // exists (this avoids resurrecting the token if it was deleted\n    // after we read it).  Using $addToSet avoids getting an index\n    // error if another client logging in simultaneously has already\n    // inserted the new hashed token.\n    accounts.users.update(\n      {\n        _id: user._id,\n        \"services.resume.loginTokens.token\": options.resume\n      },\n      {$addToSet: {\n          \"services.resume.loginTokens\": {\n            \"hashedToken\": hashedToken,\n            \"when\": token.when\n          }\n        }}\n    );\n\n    // Remove the old token *after* adding the new, since otherwise\n    // another client trying to login between our removing the old and\n    // adding the new wouldn't find a token to login with.\n    accounts.users.update(user._id, {\n      $pull: {\n        \"services.resume.loginTokens\": { \"token\": options.resume }\n      }\n    });\n  }\n\n  return {\n    userId: user._id,\n    stampedLoginToken: {\n      token: options.resume,\n      when: token.when\n    }\n  };\n};\n\nconst expirePasswordToken = (\n  accounts,\n  oldestValidDate,\n  tokenFilter,\n  userId\n) => {\n  // boolean value used to determine if this method was called from enroll account workflow\n  let isEnroll = false;\n  const userFilter = userId ? {_id: userId} : {};\n  // check if this method was called from enroll account workflow\n  if(tokenFilter['services.password.enroll.reason']) {\n    isEnroll = true;\n  }\n  let resetRangeOr = {\n    $or: [\n      { \"services.password.reset.when\": { $lt: oldestValidDate } },\n      { \"services.password.reset.when\": { $lt: +oldestValidDate } }\n    ]\n  };\n  if(isEnroll) {\n    resetRangeOr = {\n      $or: [\n        { \"services.password.enroll.when\": { $lt: oldestValidDate } },\n        { \"services.password.enroll.when\": { $lt: +oldestValidDate } }\n      ]\n    };\n  }\n  const expireFilter = { $and: [tokenFilter, resetRangeOr] };\n  if(isEnroll) {\n    accounts.users.update({...userFilter, ...expireFilter}, {\n      $unset: {\n        \"services.password.enroll\": \"\"\n      }\n    }, { multi: true });\n  } else {\n    accounts.users.update({...userFilter, ...expireFilter}, {\n      $unset: {\n        \"services.password.reset\": \"\"\n      }\n    }, { multi: true });\n  }\n\n};\n\nconst setExpireTokensInterval = accounts => {\n  accounts.expireTokenInterval = Meteor.setInterval(() => {\n    accounts._expireTokens();\n    accounts._expirePasswordResetTokens();\n    accounts._expirePasswordEnrollTokens();\n  }, EXPIRE_TOKENS_INTERVAL_MS);\n};\n\nconst OAuthEncryption = Package[\"oauth-encryption\"]?.OAuthEncryption;\n\n// OAuth service data is temporarily stored in the pending credentials\n// collection during the oauth authentication process.  Sensitive data\n// such as access tokens are encrypted without the user id because\n// we don't know the user id yet.  We re-encrypt these fields with the\n// user id included when storing the service data permanently in\n// the users collection.\n//\nconst pinEncryptedFieldsToUser = (serviceData, userId) => {\n  Object.keys(serviceData).forEach(key => {\n    let value = serviceData[key];\n    if (OAuthEncryption?.isSealed(value))\n      value = OAuthEncryption.seal(OAuthEncryption.open(value), userId);\n    serviceData[key] = value;\n  });\n};\n\n// XXX see comment on Accounts.createUser in passwords_server about adding a\n// second \"server options\" argument.\nconst defaultCreateUserHook = (options, user) => {\n  if (options.profile)\n    user.profile = options.profile;\n  return user;\n};\n\n// Validate new user's email or Google/Facebook/GitHub account's email\nfunction defaultValidateNewUserHook(user) {\n  const domain = this._options.restrictCreationByEmailDomain;\n  if (!domain) {\n    return true;\n  }\n\n  let emailIsGood = false;\n  if (user.emails && user.emails.length > 0) {\n    emailIsGood = user.emails.reduce(\n      (prev, email) => prev || this._testEmailDomain(email.address), false\n    );\n  } else if (user.services && Object.values(user.services).length > 0) {\n    // Find any email of any service and check it\n    emailIsGood = Object.values(user.services).reduce(\n      (prev, service) => service.email && this._testEmailDomain(service.email),\n      false,\n    );\n  }\n\n  if (emailIsGood) {\n    return true;\n  }\n\n  if (typeof domain === 'string') {\n    throw new Meteor.Error(403, `@${domain} email required`);\n  } else {\n    throw new Meteor.Error(403, \"Email doesn't match the criteria.\");\n  }\n}\n\nconst setupUsersCollection = users => {\n  ///\n  /// RESTRICTING WRITES TO USER OBJECTS\n  ///\n  users.allow({\n    // clients can modify the profile field of their own document, and\n    // nothing else.\n    update: (userId, user, fields, modifier) => {\n      // make sure it is our record\n      if (user._id !== userId) {\n        return false;\n      }\n\n      // user can only modify the 'profile' field. sets to multiple\n      // sub-keys (eg profile.foo and profile.bar) are merged into entry\n      // in the fields list.\n      if (fields.length !== 1 || fields[0] !== 'profile') {\n        return false;\n      }\n\n      return true;\n    },\n    fetch: ['_id'] // we only look at _id.\n  });\n\n  /// DEFAULT INDEXES ON USERS\n  users.createIndex('username', { unique: true, sparse: true });\n  users.createIndex('emails.address', { unique: true, sparse: true });\n  users.createIndex('services.resume.loginTokens.hashedToken',\n    { unique: true, sparse: true });\n  users.createIndex('services.resume.loginTokens.token',\n    { unique: true, sparse: true });\n  // For taking care of logoutOtherClients calls that crashed before the\n  // tokens were deleted.\n  users.createIndex('services.resume.haveLoginTokensToDelete',\n    { sparse: true });\n  // For expiring login tokens\n  users.createIndex(\"services.resume.loginTokens.when\", { sparse: true });\n  // For expiring password tokens\n  users.createIndex('services.password.reset.when', { sparse: true });\n  users.createIndex('services.password.enroll.when', { sparse: true });\n};\n\n\n// Generates permutations of all case variations of a given string.\nconst generateCasePermutationsForString = string => {\n  let permutations = [''];\n  for (let i = 0; i < string.length; i++) {\n    const ch = string.charAt(i);\n    permutations = [].concat(...(permutations.map(prefix => {\n      const lowerCaseChar = ch.toLowerCase();\n      const upperCaseChar = ch.toUpperCase();\n      // Don't add unnecessary permutations when ch is not a letter\n      if (lowerCaseChar === upperCaseChar) {\n        return [prefix + ch];\n      } else {\n        return [prefix + lowerCaseChar, prefix + upperCaseChar];\n      }\n    })));\n  }\n  return permutations;\n}\n\n"]}