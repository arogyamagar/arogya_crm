{"version":3,"names":["fs","require","path","createHash","Module","module","constructor","exports","enable","cachePath","createLoader","cacheEnabled","cacheEntries","Object","create","readdirSync","forEach","name","e","code","mkdirSync","Mp","prototype","resolve","id","_resolveFilename","moduleLoad","load","filename","result","apply","arguments","runSetters","resolved","Promise","dynamicImport","then","reifyVersion","version","reifyBabelParse","parse","reifyCompile","compile","compileContent","content","identical","generateLetDeclarations","ast","_compile","options","compiledWithReify","call","jsExt","_extensions","js","stat","statSync","baseKey","update","mtimeMs","ino","size","digest","identicalKey","key","readFileSync","join","origContent","writeFileLater","immediateTimer","pendingWrites","setImmediate","keys","targetPath","tempPath","writeFileSync","renameSync","err"],"sources":["/tools/static-assets/server/runtime.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst { createHash } = require(\"crypto\");\nconst Module = module.constructor;\n\nmodule.exports = function enable ({ cachePath, createLoader = true } = {}) {\n  let cacheEnabled = !!cachePath;\n  let cacheEntries = Object.create(null);\n\n  if (cachePath) {\n    try {\n      fs.readdirSync(cachePath).forEach(name => {\n        cacheEntries[name] = true;\n      });\n    } catch (e) {\n      if (e.code === 'ENOENT') {\n        fs.mkdirSync(cachePath);\n      } else {\n        cacheEnabled = false;\n      }\n    }\n  }\n\n  const Mp = Module.prototype;\n\n  Mp.resolve = function (id) {\n    return Module._resolveFilename(id, this);\n  };\n\n  // Enable the module.{watch,export,...} runtime API needed by Reify.\n  require(\"@meteorjs/reify/lib/runtime\").enable(Mp);\n\n  const moduleLoad = Mp.load;\n  Mp.load = function (filename) {\n    const result = moduleLoad.apply(this, arguments);\n    if (typeof this.runSetters === \"function\") {\n      // Make sure we call module.runSetters (or module.runModuleSetters, a\n      // legacy synonym) whenever a module finishes loading.\n      this.runSetters();\n    }\n    return result;\n  };\n\n  const resolved = Promise.resolve();\n  Mp.dynamicImport = function (id) {\n    return resolved.then(() => require(id));\n  };\n\n  const reifyVersion = require(\"@meteorjs/reify/package.json\").version;\n  const reifyBabelParse = require(\"@meteorjs/reify/lib/parsers/babel\").parse;\n  const reifyCompile = require(\"@meteorjs/reify/lib/compiler\").compile;\n\n  function compileContent (content) {\n    let identical = true;\n\n    try {\n      const result = reifyCompile(content, {\n        parse: reifyBabelParse,\n        generateLetDeclarations: false,\n        ast: false,\n      });\n      if (!result.identical) {\n        identical = false;\n        content = result.code;\n      }\n    } finally {\n      return { content, identical };\n    }\n  }\n\n  const _compile = Mp._compile;\n  Mp._compile = function (content, filename, options) {\n    // When cache is enabled, the file has already been compiled\n    if (!options || !options.compiledWithReify) {\n      content = compileContent(content).content;\n    }\n\n    return _compile.call(this, content, filename);\n  };\n\n  if (cacheEnabled) {\n    const jsExt = Module._extensions.js;\n    Module._extensions['.js'] = function (module, filename) {\n      let stat = fs.statSync(filename);\n      let baseKey = createHash(\"sha1\")\n        .update(`${reifyVersion}\\0${filename}\\0${stat.mtimeMs}\\0${stat.ino}\\0${stat.size}\\0`)\n        .digest('hex');\n\n      // When files don't use import/export, there is no reason to store\n      // an identical copy of the file in the cache. Instead, it stores an empty\n      // file with a different suffix to indicate the original file should be used\n      let identicalKey = baseKey + '-identical.json';\n      let key = baseKey + '.json';\n\n      let content;\n      if (cacheEntries[key]) {\n        content = fs.readFileSync(path.join(cachePath, key), 'utf8');\n      } else if (cacheEntries[identicalKey]) {\n        content = fs.readFileSync(filename, 'utf8');\n      } else {\n        let origContent = fs.readFileSync(filename, 'utf8');\n        let result = compileContent(origContent);\n        content = result.content;\n\n        if (result.identical) {\n          writeFileLater(identicalKey, '');\n        } else {\n          writeFileLater(key, content);\n        }\n      }\n\n      return module._compile(content, filename, { compiledWithReify: true });\n    }\n  }\n\n  let immediateTimer = null;\n  let pendingWrites = Object.create(null);\n  function writeFileLater(key, content) {\n    pendingWrites[key] = content;\n    if (immediateTimer !== null) {\n      return;\n    }\n\n    immediateTimer = setImmediate(() => {\n      immediateTimer = null;\n      Object.keys(pendingWrites).forEach(key => {\n        try {\n          let targetPath = path.resolve(cachePath, key);\n          let tempPath = targetPath + '.tmp';\n          fs.writeFileSync(tempPath, pendingWrites[key]);\n          fs.renameSync(tempPath, targetPath);\n        } catch (err) {\n        }\n      });\n\n      pendingWrites = Object.create(null);\n    });\n  }\n}\n"],"mappings":"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","file":"tools/static-assets/server/runtime.js.map"}